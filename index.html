<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スマホ利用と認知能力調査</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <!-- IPAexフォントをBase64で埋め込み -->
  <script src="https://unpkg.com/jspdf-font-ipaex@1.0.2/ipaexg.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .hidden { display: none; }
    button { margin-top: 10px; padding: 6px 12px; }
    input, textarea { width: 300px; margin: 4px 0; }
  </style>
</head>
<body>

<h2>説明文</h2>
<p>このアンケートは、高校生のスマホ利用と認知能力の関係に関する調査に使われます。※数分の時間を要します。</p>
<button onclick="startSurvey()">アンケートを開始</button>

<div id="survey1" class="hidden">
  <h3>調査１　アンケート調査</h3>
  <label>(1) 平日のスマートフォン利用時間：<input type="number" id="weekdayHours"> 時間</label><br>
  <label>(2) 休日のスマートフォン利用時間：<input type="number" id="weekendHours"> 時間</label><br>
  <label>(3) スマートフォン機能の利用頻度順：<input type="text" id="functionOrder" placeholder="例: 2,1,3,4,5,6"></label><br>
  <label>(4) その他の利用方法：<br><textarea id="otherUsage"></textarea></label><br>
  <label>(5) 一日の平均睡眠時間：<input type="number" id="sleepHours"> 時間</label><br>
  <p>入力が完了したら以下のボタンを押してください。</p>
  <button onclick="finishSurvey1()">入力完了</button>
</div>

<div id="wordTest" class="hidden">
  <h3>調査２ 認知能力テスト (1) 単語リスト再生</h3>
  <p>これから、15個の単語が順番に表示されます。それらを順番に1~15の欄にできるだけ記入してください。<br>
  メモを取らないようにお願いします。解答が終わったら「解答完了」を押してください。</p>
  <div id="wordDisplay"></div>
  <div id="wordAnswer" class="hidden">
    <div id="wordInputs"></div>
    <button onclick="finishWordTest()">解答完了</button>
  </div>
</div>

<div id="stroopTest" class="hidden">
  <h3>調査２ 認知能力テスト (2) ストループ課題</h3>
  <p>画面に色の名前が表示されます。文字の色（表示色）を答えてください。<br>
  意味（文字の読み）ではなく、表示色を選んでください。なるべく素早く回答してください。</p>
  <div id="stroopQuestion" style="font-size:24px; margin:20px;"></div>
  <div id="stroopChoices"></div>
</div>

<div id="endMessage" class="hidden">
  <h3>説明文</h3>
  <p>テストは以上です。お手数ですが、ダウンロードされたPDFファイルをLINEで送信していただけると、情報収集ができ助かります。ご協力をおねがいします。</p>
  <button onclick="downloadPDF()">PDFをダウンロード</button>
</div>

<script>
let survey1Data = {};
let wordList = ["犬","机","空","山","水","音","夢","花","月","本","海","道","鳥","手","光"];
let wordAnswers = [];
let correctWords = 0;

let stroopTrials = [];
let stroopTimes = [];
let stroopCorrect = 0;
let currentTrial = 0;
let startTime;

function startSurvey(){
  document.querySelector("button").style.display="none";
  document.getElementById("survey1").classList.remove("hidden");
}

function finishSurvey1(){
  survey1Data.weekdayHours = document.getElementById("weekdayHours").value;
  survey1Data.weekendHours = document.getElementById("weekendHours").value;
  survey1Data.functionOrder = document.getElementById("functionOrder").value;
  survey1Data.otherUsage = document.getElementById("otherUsage").value;
  survey1Data.sleepHours = document.getElementById("sleepHours").value;

  document.getElementById("survey1").classList.add("hidden");
  document.getElementById("wordTest").classList.remove("hidden");

  showWords();
}

function showWords(){
  let i=0;
  let display=document.getElementById("wordDisplay");
  let interval=setInterval(()=>{
    display.textContent=wordList[i];
    i++;
    if(i>=wordList.length){
      clearInterval(interval);
      setTimeout(()=>{
        display.textContent="";
        let inputs=document.getElementById("wordInputs");
        inputs.innerHTML="";
        for(let j=0;j<15;j++){
          inputs.innerHTML+=`${j+1}番目: <input type="text" id="ans${j}"><br>`;
        }
        document.getElementById("wordAnswer").classList.remove("hidden");
      },5000);
    }
  },2000);
}

function finishWordTest(){
  wordAnswers=[];
  for(let i=0;i<15;i++){
    let val=document.getElementById("ans"+i).value.trim();
    wordAnswers.push(val);
  }
  correctWords=wordAnswers.filter((w,i)=>w===wordList[i]).length;
  document.getElementById("wordTest").classList.add("hidden");
  document.getElementById("stroopTest").classList.remove("hidden");
  startStroop();
}

function startStroop(){
  stroopTrials=[
    {text:"赤",color:"blue"},
    {text:"青",color:"green"},
    {text:"緑",color:"red"},
    {text:"黄",color:"purple"},
    {text:"黒",color:"orange"},
    {text:"紫",color:"red"},
    {text:"橙",color:"green"},
    {text:"白",color:"black"},
    {text:"水",color:"brown"},
    {text:"茶",color:"pink"}
  ];
  showStroopTrial();
}

function showStroopTrial(){
  if(currentTrial>=stroopTrials.length){
    document.getElementById("stroopTest").classList.add("hidden");
    document.getElementById("endMessage").classList.remove("hidden");
    return;
  }
  let trial=stroopTrials[currentTrial];
  let q=document.getElementById("stroopQuestion");
  q.textContent=trial.text;
  q.style.color=trial.color;
  let choices=["red","blue","green","yellow","purple","orange","black","white","brown","pink"];
  let buttons=document.getElementById("stroopChoices");
  buttons.innerHTML="";
  choices.forEach(c=>{
    let b=document.createElement("button");
    b.textContent=c;
    b.onclick=()=>checkStroop(c);
    buttons.appendChild(b);
  });
  startTime=new Date();
}

function checkStroop(answer){
  let trial=stroopTrials[currentTrial];
  let end=new Date();
  stroopTimes.push((end-startTime)/1000);
  if(answer===trial.color) stroopCorrect++;
  currentTrial++;
  showStroopTrial();
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("ipaexg","normal");

  doc.setFontSize(16);
  doc.text("調査結果", 14, 20);

  doc.setFontSize(12);
  doc.text("調査１ アンケート調査", 14, 30);
  doc.autoTable({
    startY: 35,
    head: [["項目", "回答"]],
    body: [
      ["平日利用時間", survey1Data.weekdayHours+"時間"],
      ["休日利用時間", survey1Data.weekendHours+"時間"],
      ["機能利用順序", survey1Data.functionOrder],
      ["その他利用", survey1Data.otherUsage],
      ["睡眠時間", survey1Data.sleepHours+"時間"]
    ]
  });

  doc.text("調査２-1 単語リスト再生", 14, doc.lastAutoTable.finalY + 10);
  let wordBody = wordAnswers.map((w,i)=>[`${i+1}番目`, w]);
  wordBody.push(["正答率", `${(correctWords/15*100).toFixed(1)}%`]);
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 15,
    head: [["番号", "解答"]],
    body: wordBody
  });

  doc.text("調査２-2 ストループ課題", 14, doc.lastAutoTable.finalY + 10);
  let stroopBody = stroopTimes.map((t,i)=>[`試行${i+1}`, t.toFixed(2)+"秒"]);
  stroopBody.push(["正答率", `${(stroopCorrect/stroopTrials.length*100).toFixed(1)}%`]);
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 15,
    head: [["試行", "反応時間"]],
    body: stroopBody
  });

  doc.save("survey_results.pdf");
}
</script>
</body>
</html>
```
